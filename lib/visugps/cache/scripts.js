/*
License: GNU General Public License

This file is part of VisuGps

VisuGps is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.

VisuGps is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with VisuGps; if not, write to the Free Software
Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

Copyright (c) 2007 Victor Berchet, <http://www.victorb.fr>

Credits:
        - This script uses a modified version of chart by WebFX.
          <http://webfx.eae.net/dhtml/chart/chart.html>
        - Some code is inspired from by the Google Maps API tutorial of
          Mike Williams <http://www.econym.demon.co.uk/googlemaps/index.htm>

*/
var Charts=new Class({options:{cursor:true,keySupport:true,onMouseMove:Class.empty,onMouseDown:Class.empty,onMouseWheel:Class.empty},initialize:function(div,options){this.setOptions(options);this.chartDiv=$(div);this.charts=[];this.sortable=null;this.curPos=0;this.position=0;if(this.options.cursor){this.cursorDiv=new Element('div',{'styles':{'position':'absolute','border-left':'dashed 1px #508','width':0,'z-index':80,'visibility':'hidden'}}).injectInside($(div)).addEvents({'mousedown':this._down.bindWithEvent(this),'mousewheel':this._wheel.bindWithEvent(this)});}
$(div).addEvents({'mousemove':this._move.bindWithEvent(this),'mousedown':this._down.bindWithEvent(this),'mousewheel':this._wheel.bindWithEvent(this)});if(this.options.keySupport)document.addEvent('keydown',this._move.bindWithEvent(this));function stopEvent(event){(new Event(event)).stop()};this.sliders=new Element('ul',{'styles':{'position':'absolute','top':0,'right':0,'width':'13ex','background':'#FFC','border':'1px solid #333'},'events':{'mousemove':stopEvent,'mousedown':stopEvent,'mousewheel':stopEvent}}).injectInside($(div));},draw:function(){if(this.charts.length){this.charts.each(function(chart){chart.draw();});if(!this.sortable){function setZOrder(){var order=this.sortable.serialize();order.each(function(item,index){$('div-sld-'+item).setStyle('z-index',20-index);});};this.sortable=new Sortables(this.sliders,{'handles':'.vgps-legend','onComplete':setZOrder.bind(this)});}
if(this.options.cursor){var dim=this.charts[0].getCoordinates();this.cursorDiv.setStyles({'top':dim.top,'height':dim.height});}}},add:function(label,opacity,color,options){label=$pick(label,'label');opacity=$pick(opacity.limit(0,1),1);color=$pick(color,'#f00');function setOpacity(opacity){div.setStyle('opacity',opacity/100);}
var id='sld-'+this.charts.length;var div=new Element('div',{'class':'chart vgps-chart','styles':{'opacity':opacity},'id':'div-'+id}).injectTop(this.chartDiv);var chart=new Chart(div,$pick(options,{}));this.charts.push(chart);var slider=new Element('li').setHTML('<div id="'+id+'" class="vgps-slider"></div>'+'<span class="vgps-legend">'+label+'</span>').injectInside(this.sliders);new SliderProgress(id,{'color':color,'onChange':setOpacity}).set(opacity*100);return chart;},setCursor:function(pos){if(this.options.cursor&&this.charts.length){var dim=this.charts[0].getCoordinates();this.position=pos=pos.limit(0,1000);var left=dim.left+this.chartDiv.getLeft();var x=(pos*dim.width/1000)+left;this.cursorDiv.setStyle('left',x);this.showCursor();}},showCursor:function(visible){if(this.options.cursor){visible=$pick(visible,true);this.cursorDiv.setStyle('visibility',visible?'visible':'hidden');}},clean:function(){this.showCursor(false);this.chartDiv.empty();},_move:function(event){if(this.charts.length){var pos=this.position;if(event.type.contains('key')){var offset=0;if(event.key==='left')offset=-1;if(event.key==='right')offset=1;if(offset!=0)event.stop();offset=event.shift?10*offset:offset;pos+=offset;}else{event.stop();var x=event.page.x;var dim=this.charts[0].getCoordinates();var left=dim.left+this.chartDiv.getLeft();x=x<left?left:x;x=x>(left+dim.width)?left+dim.width:x;pos=(1000*(x-left)/dim.width).toInt();}
pos=pos.limit(0,1000);this.setCursor(pos);this.fireEvent('onMouseMove',pos);}},_down:function(event){this.fireEvent('onMouseDown',this.position);},_wheel:function(event){this.fireEvent('onMouseWheel',[this.position,event.wheel]);}});Charts.implement(new Events,new Options);var SliderProgress=new Class({options:{onChange:Class.empty,onComplete:Class.empty,mode:'horizontal',steps:100,color:'#f00',border:1,opacity:0.6},initialize:function(el,options){this.setOptions(options);var opt=this.options;this.element=$(el);opt.border?this.element.setStyle('border-width',opt.border):opt.boder=0;this.capture=false;this._mouseMoveWrapper=this._mouseMove.bindWithEvent(this);this._updateDim();switch(opt.mode){case'horizontal':this.valStyle='width';this.valRef='left';this.valMod='x';this.max=this.dim.width;break;case'vertical':this.valStyle='height';this.valRef='top';this.valMod='y';this.max=this.dim.height;break;}
this.bar=new Element('div',{'styles':{'height':this.dim.height,'width':this.dim.width,'float':'left','background':opt.color,'opacity':opt.opacity}}).injectInside(this.element);this.value=0;this.element.addEvents({'mouseup':this._mouseUp.bindWithEvent(this),'mouseleave':this._mouseUp.bindWithEvent(this),'mousedown':this._mouseDown.bindWithEvent(this)});if(opt.initialize)opt.initialize.call(this);},set:function(value){this._checkValue(value);this._update(this._toPosition(this.value));return this;},_mouseDown:function(event){this._startCapture();this._updateDim();this._update(event.page[this.valMod]-this.dim[this.valRef]);},_mouseUp:function(event){if(!this.capture){return;}
this._endCapture();var position=event.page[this.valMod]-this.dim[this.valRef];this._update(position);var value=this._toStep(position);this._change('onChange',value);this._change('onComplete',value);},_mouseMove:function(event){var position=event.page[this.valMod]-this.dim[this.valRef];this._update(position);this._checkValue(this._toStep(position));},_checkValue:function(value){if(this.value!=value){this.value=value;this._change('onChange',value);}},_toStep:function(position){return Math.round(position/this.dim[this.valStyle]*this.options.steps);},_toPosition:function(value){return this.dim[this.valStyle]*value/this.options.steps;},_update:function(pos){this.bar.setStyle(this.valStyle,pos.limit(0,this.max));},_change:function(event,value){this.fireEvent(event,value.limit(0,this.options.steps))},_startCapture:function(){this.element.addEvent('mousemove',this._mouseMoveWrapper);this.capture=true;},_endCapture:function(){this.element.removeEvent('mousemove',this._mouseMoveWrapper);this.capture=false;},_updateDim:function(){this.dim=this.element.getCoordinates();this.dim.width-=2*this.options.border;this.dim.height-=2*this.options.border;}});SliderProgress.implement(new Events,new Options);var VisuGps=new Class({options:{mapDiv:'map',chartDiv:'vgps-chartcont',loadDiv:'load',elevTileUrl:null,weatherTileUrl:null,measure:true,measureCfd:true,maxSpeed:80,maxVario:10,maxElev:9999,proxyPath:'vg_proxy.php'},initialize:function(options){this.setOptions(options);this.map={};this.track={};this.points=[];this.charts=null;this.marker={};this.path=null;this.timer=null;this.infoCtrl={};this.titleCtrl={};this.nfo=null;this.animTimer=null;this.animPos=0;this.animDelay={'min':1,'max':120,'val':60};this.mapTitle='VisuGps';this.distPts={};this.distState=0;this.distLine={};if(GBrowserIsCompatible()){var map=$(this.options.mapDiv);if(!map)return;this.map=new google.maps.Map2(map);this.map.setCenter(new google.maps.LatLng(46.73986,2.17529),5,G_HYBRID_MAP);this.map.addControl(new google.maps.MapTypeControl());this.map.addControl(new google.maps.LargeMapControl());this.map.addControl(new google.maps.ScaleControl());this.map.enableScrollWheelZoom();this.map.disableDoubleClickZoom();this._createTitleControl('VisuGps');this.map.addControl(this.titleCtrl);}},clean:function(){google.maps.Unload();if(this.charts)this.charts.clean();window.removeEvents('resize');},setTrack:function(track){this.track=track;var opt=this.options;var load=$(opt.loadDiv);if($defined(track.error)){if(load){load.setHTML(track.error);new Fx.Styles(load,{transition:Fx.Transitions.linear}).start({'opacity':0.9,'background-color':'#ff2222'});}
return;}
if($defined(track.kmlUrl)){var me=this;var kml=new google.maps.GeoXml(track.kmlUrl,function(){if(kml.loadedCorrectly()){kml.gotoDefaultViewport(me.map);me.map.addOverlay(kml);if(load){load.effect('opacity',{onComplete:function(){load.remove();}}).start(1,0);}
$(me.options.chartDiv).setHTML('<p style="text-align:center;margin:20px;font:10px Verdana, Arial, sans-serif;">'+'<b>No graph available for KML files</b>'+'</p>');}});}else{this._createInfoControl();this.map.addControl(this.infoCtrl);this.nfo=$('vgps-nfofield');var bounds=new google.maps.LatLngBounds();var point={};for(var i=0;i<this.track.nbTrackPt;i++){point=new google.maps.LatLng(this.track.lat[i],this.track.lon[i]);this.points.push(point);bounds.extend(point);}
var maxSpeed=opt.maxSpeed;var maxVario=opt.maxVario;var minVario=-maxVario;var maxElev=opt.maxElev;for(i=this.track.nbChartPt-1;i>=0;i--){this.track.speed[i]=this.track.speed[i].limit(0,maxSpeed);this.track.vario[i]=this.track.vario[i].limit(minVario,maxVario);this.track.elev[i]=this.track.elev[i].limit(0,maxElev);}
this.map.setCenter(bounds.getCenter(),this.map.getBoundsZoomLevel(bounds));this._displayTrack();this.marker=new google.maps.Marker(this.points[0],{clickable:false});this._showMarker(0);this.map.addOverlay(this.marker);google.maps.Event.addListener(this.map,'moveend',this._displayTrack.bind(this));window.addEvent('resize',this._resize.bind(this));this.mapTitle=[this.track.date.day,this.track.date.month,this.track.date.year].join('/');if((this.mapTitle!=='0/0/0')&&($type(opt.weatherTileUrl)==='array')){this._createModisMap(this.track.date.day,this.track.date.month,this.track.date.year);}
if(this.track.pilot)this.mapTitle+='<br/>'+this.track.pilot;this.titleCtrl.setText(this.mapTitle);if($type(opt.elevTileUrl)==='array'){this._createSrtmMap();}
var h=$('vgps-anim').getParent().getCoordinates().height+
$('vgps-anim').getCoordinates().height;$('vgps-anim').getParent().setStyle('height',h);this._initGraph();if(load){load.effect('opacity',{onComplete:function(){load.remove();}}).start(1,0);}}
google.maps.Event.addListener(this.map,'click',this._leftClick.bind(this));if(opt.measure){google.maps.Event.addListener(this.map,'singlerightclick',this._rightClick.bind(this));}},downloadTrack:function(url){new Json.Remote(this.options.proxyPath+'?track='+url,{onComplete:this.setTrack.bind(this)}).send();},_toggleAnim:function(e){if(e.rightClick){this.animPos=0;$clear(this.animTimer);this.animTimer=null;var playGif=$('vgps-anim').getStyle('background-image').replace(/pause/,'play');$('vgps-anim').setStyle('background-image',playGif);this._animate();}else{if(this.animTimer===null){this.animTimer=this._animate.periodical(this.animDelay.val,this);this.charts.showCursor(true);var pauseGif=$('vgps-anim').getStyle('background-image').replace(/play/,'pause');$('vgps-anim').setStyle('background-image',pauseGif);}else{$clear(this.animTimer);this.animTimer=null;var playGif=$('vgps-anim').getStyle('background-image').replace(/pause/,'play');$('vgps-anim').setStyle('background-image',playGif);}}},_setAnimDelay:function(val){this.animDelay.val=this.animDelay.min+
(100-val)/100*(this.animDelay.max-this.animDelay.min);if(this.animTimer!==null){$clear(this.animTimer);this.animTimer=this._animate.periodical(this.animDelay.val,this);}},_animate:function(){if(this.animPos>=1000){this.animPos=0;$clear(this.animTimer);this.animTimer=null;var playGif=$('vgps-anim').getStyle('background-image').replace(/pause/,'play');$('vgps-anim').setStyle('background-image',playGif);}else{this._showMarker(this.animPos);this.charts.setCursor(this.animPos++);if(!this.map.getBounds().contains(this.marker.getPoint())){this.map.setCenter(this.marker.getPoint());}}},_rightClick:function(point){this.distState++;switch(this.distState){case 1:var ptll=this.map.fromContainerPixelToLatLng(point);this.distPts=[ptll];this.distLine=null;google.maps.Event.addListener(this.map,'mousemove',this._mouseMove.bind(this));this._mouseMove(ptll);break;case 2:google.maps.Event.clearListeners(this.map,'mousemove');break;case 3:if(this.distLine)this.map.removeOverlay(this.distLine);this.titleCtrl.setText(this.mapTitle);default:this.distState=0;}},_mouseMove:function(point){var dPts=this.distPts.concat([point]);if(this.distLine){this.map.removeOverlay(this.distLine);this.distLine=null;}
this.distLine=new google.maps.Polyline(dPts,'#ff0',4,0.6,{'clickable':false});this.map.addOverlay(this.distLine);var dist=this.distLine.getLength();var legend;if(dist<1000){legend=(Math.round(dist*100)/100)+' m';}else{legend=(Math.round(dist/10)/100)+' km';}
if(this.options.measureCfd){var type=null;var coef=1.2;switch(dPts.length){case 2:type='DL';coef=1;break;case 3:if(dPts[0].distanceFrom(dPts[2])<3000){type='AR'}else{type='DL1';coef=1;}
break;case 4:if(dPts[0].distanceFrom(dPts[3])<3000){var fai=true;for(var idx=0;idx<3;idx++){if(dPts[idx].distanceFrom(dPts[idx+1])<0.28*dist){fai=false;break;}}
type=fai?'FAI':'TR';coef=fai?1.4:1.2;}else{type='DL2';coef=1;}
break;case 5:if(dPts[0].distanceFrom(dPts[4])<3000){type='QD';}
break;default:}
if(type!==null){legend+='<br/>'+type+' '+(Math.round(coef*dist/10)/100)+' pts';}}
this.titleCtrl.setText(legend);},_leftClick:function(marker,point){if(point===null)return;switch(this.distState){case 1:this.distPts.push(point);this._mouseMove(point);break;default:if(this.points.length){var bestIdx=0;var bestDst=this.points[0].distanceFrom(point);var dst;for(var i=this.points.length-1;i>=0;i--){dst=this.points[i].distanceFrom(point);if(dst<bestDst){bestIdx=i;bestDst=dst;}}
this.marker.setPoint(this.points[bestIdx]);var pos=(1000*bestIdx/this.track.nbTrackPt).toInt();this.charts.setCursor(pos);this._showInfo(pos);}}},_initGraph:function(){this.charts=new Charts($(this.options.chartDiv),{onMouseMove:this._showMarker.bind(this),onMouseDown:this._showMarkerCenter.bind(this),onMouseWheel:this._showMarkerCenterZoom.bind(this)});var chart=this.charts.add('h',0.9,'#f00');chart.setGridDensity(this.track.nbChartLbl,4);chart.setHorizontalLabels(this.track.time.label);chart.add('hV','#f00',this.track.elev,CHART_LINE);chart.add('hS','#755545',this.track.elevGnd,CHART_AREA);chart=this.charts.add('Vx',0.2,'#0f0');chart.setGridDensity(this.track.nbChartLbl,4);chart.setHorizontalLabels(this.track.time.label);chart.add('Vx','#0f0',this.track.speed,CHART_LINE);chart=this.charts.add('Vz',0.2,'#00f');chart.setLabelPrecision(1);chart.setGridDensity(this.track.nbChartLbl,4);chart.setHorizontalLabels(this.track.time.label);chart.add('Vz','#00f',this.track.vario,CHART_LINE);this._drawGraph();},_resize:function(){this.charts.showCursor(false);if(this.timer)$clear(this.timer);this.timer=this._drawGraph.delay(100,this);},_drawGraph:function(){if(this.points.length<5)return;this.charts.draw();},_displayTrack:function(){if(this.points.length<5)return;var path=new google.maps.Polyline(this._getReducedTrack(),"#f00",1,1,{'clickable':false});if(this.path){this.map.removeOverlay(this.path);}
this.map.addOverlay(this.path=path);},_getReducedTrack:function(){var Sw=this.map.getBounds().getSouthWest();var Ne=this.map.getBounds().getNorthEast();var deltaLat=Ne.lat()-Sw.lat();var deltaLng=Ne.lng()-Sw.lng();var bufSw=new google.maps.LatLng(Sw.lat()-deltaLat,Sw.lng()-deltaLng);var bufNe=new google.maps.LatLng(Ne.lat()+deltaLat,Ne.lng()+deltaLng);var scrollBuffer=new google.maps.LatLngBounds(bufSw,bufNe);var minStepLat=3*deltaLat/this.map.getSize().width;var minStepLng=3*deltaLng/this.map.getSize().height;var lastLat=this.points[0].lat();var lastLng=this.points[0].lng();var shortTrack=[];var point={};shortTrack.push(this.points[this.points.length-1]);for(var i=this.points.length-1;i>=0;i--){point=this.points[i];if(scrollBuffer.contains(point)&&((Math.abs(point.lat()-lastLat)>minStepLat)||(Math.abs(point.lng()-lastLng)>minStepLng))){shortTrack.unshift(point);lastLat=point.lat();lastLng=point.lng();}}
return shortTrack;},_showMarker:function(pos,center){center=$pick(center,false);var idx=(pos*(this.track.nbTrackPt-1)/1000).toInt();this.marker.setPoint(this.points[idx]);this._showInfo(pos);if(center){this.map.panTo(this.points[idx]);}},_showMarkerCenter:function(pos){this._showMarker(pos,true);},_showMarkerCenterZoom:function(pos,wheel){if(wheel>0){this.map.zoomIn();}else{this.map.zoomOut();}
this._showMarker(pos,true);},_showInfo:function(pos){var idx=(pos*(this.track.nbChartPt-1)/1000).toInt();this.nfo.setHTML(this.track.elev[idx]+'m [hV]<br/>'+
this.track.elevGnd[idx]+'m [hS]<br/>'+
Math.max(0,(this.track.elev[idx]-this.track.elevGnd[idx]))+'m [hR]<br/>'+
this.track.vario[idx]+'m/s [Vz]<br/>'+
this.track.speed[idx]+'km/h [Vx]<br/>'+
this._NbToStrW(this.track.time.hour[idx],2)+':'+
this._NbToStrW(this.track.time.min[idx],2)+':'+
this._NbToStrW(this.track.time.sec[idx],2)+'[Th]');},_createTitleControl:function(title){function TitleControl(title){this.div=null;this.title=title;}
TitleControl.prototype=new google.maps.Control();TitleControl.prototype.initialize=function(map){this.div=new Element('div',{'styles':{'color':'#000','border':'1px inset #555','padding':'2px','font':'10px Verdana, Arial, sans-serif','marginBottom':'3px','background':'#FFC','text-align':'right','opacity':'0.9'}}).setHTML(this.title).injectInside(map.getContainer());return this.div;}
TitleControl.prototype.getDefaultPosition=function(){return new google.maps.ControlPosition(G_ANCHOR_TOP_RIGHT,new GSize(7,30));}
TitleControl.prototype.setText=function(title){this.title=title;this.div.setHTML(title);}
this.titleCtrl=new TitleControl(title);},_createInfoControl:function(){function InfoControl(){}
var me=this;InfoControl.prototype=new google.maps.Control();InfoControl.prototype.selectable=function(){return false;}
InfoControl.prototype.initialize=function(map){var div=new Element('div',{'styles':{'border':'1px inset #555','padding':'2px','margin':'1px','background':'#FFC','opacity':'0.9','text-align':'right','font':'10px Verdana, Arial, sans-serif'}}).setHTML('<p class="vgps-info"><strong>...iNfO</strong></p>'+'<p class="vgps-info" id="vgps-nfofield"></p>'+'<div id="vgps-anim"><div id="vgps-play"></div></div>'+'</div>').injectInside(map.getContainer());$('vgps-play').addEvent('mousedown',function(event){(new Event(event)).stop();});$('vgps-anim').addEvent('mousedown',me._toggleAnim.bindWithEvent(me));new SliderProgress('vgps-play',{'color':'#FF850C','onChange':me._setAnimDelay.bind(me)}).set(50);return div;}
InfoControl.prototype.getDefaultPosition=function(){return new google.maps.ControlPosition(G_ANCHOR_BOTTOM_RIGHT,new GSize(2,12));}
this.infoCtrl=new InfoControl();},_createSrtmMap:function(){var srtmCpy=new google.maps.Copyright(1,new google.maps.LatLngBounds(new google.maps.LatLng(-90,-180),new google.maps.LatLng(90,180)),0,"SRTM");var srtmCpyC=new google.maps.CopyrightCollection();srtmCpyC.addCopyright(srtmCpy);var url=this.options.elevTileUrl;url.map(function(item,idx){return item.replace(/\/$/,'');});var srtmTL=[new google.maps.TileLayer(srtmCpyC,0,16)];srtmTL[0].getTileUrl=function(point,zoom){var count=url.length;var n=(point.x+point.y)%count;return'http://'+url[n]+'/vg_tilesrtm.php?x='+point.x+'&y='+point.y+'&z='+zoom;}
var srtmMap=new google.maps.MapType(srtmTL,new google.maps.MercatorProjection(18),'Elevation');this.map.addMapType(srtmMap);},_createModisMap:function(day,month,year){function EuclideanProjection(){}
EuclideanProjection.prototype=new google.maps.Projection();EuclideanProjection.prototype.fromLatLngToPixel=function(point,zoom){var size=Math.pow(2,zoom)*256;var x=Math.round((point.lng()+180)*size/360);var y=Math.round((90-point.lat())*size/180);return new GPoint(x,y)}
EuclideanProjection.prototype.fromPixelToLatLng=function(point,zoom,unbounded){var size=Math.pow(2,zoom)*256;var lng=point.x*360/size-180;var lat=90-(point.y*180/size);return new GLatLng(lat,lng,unbounded);}
EuclideanProjection.prototype.tileCheckRange=function(tile,zoom,unbounded){var size=Math.pow(2,zoom);if(tile.y<0||tile.y>=size)return false;if(tile.x<0||tile.x>=size){tile.x%=size;if(tile.x<0)tile.x+=size;}
return true;}
EuclideanProjection.prototype.getWrapWidth=function(zoom){return Math.pow(2,zoom)*256;}
function getDayNumber(day,month,year){var now=new Date;now.setUTCFullYear(year,month-1,day);var ny=new Date;ny.setUTCFullYear(year,0,1);return(now-ny)/(1000*3600*24)+1;}
var dayNum=this._NbToStrW(getDayNumber(day,month,year),3);var date=year.toString()+dayNum;var modisCpy=new google.maps.Copyright(1,new google.maps.LatLngBounds(new google.maps.LatLng(-90,-180),new google.maps.LatLng(90,180)),0,"MODIS");var modisCpyC=new google.maps.CopyrightCollection();modisCpyC.addCopyright(modisCpy);var url=this.options.weatherTileUrl;url.map(function(item,idx){return item.replace(/\/$/,'');});var modisTL=[new google.maps.TileLayer(modisCpyC,0,9)];modisTL[0].getTileUrl=function(point,zoom){var count=url.length;var n=(point.x+point.y)%count;return'http://'+url[n]+'/vg_tilemodis.php?x='+point.x+'&y='+point.y+'&z='+zoom+'&date='+date;}
var modisMap=new google.maps.MapType(modisTL,new EuclideanProjection(18),"Weather");this.map.addMapType(modisMap);},_NbToStrW:function(nb,w){var nbs=nb.toString();while(nbs.length<w)nbs='0'+nbs;return nbs;}});VisuGps.implement(new Options);var CanvasChartPainter=new Class({calc:function(w,h,xlen,ymin,ymax,xgd,ygd){this.range=ymax-ymin;this.xstep=w/(xlen-1);this.xgrid=xgd?w/(xgd-1):0;this.ygrid=ygd?h/(ygd-1):0;this.ymin=ymin;this.ymax=ymax;},initialize:function(el,xlen,ymin,ymax,xgd,ygd,bLegendLabels){this.el=el=$(el);el.empty();var dim=el.getCoordinates();this.w=this.chartw=dim.width;this.h=this.charth=dim.height;this.canvas=new Element('canvas',{'styles':{'width':this.w,'height':this.h}}).injectInside(el);this.canvas.width=this.w;this.canvas.height=this.h;if((!this.canvas.getContext)&&(typeof G_vmlCanvasManager!="undefined")){this.canvas=G_vmlCanvasManager.initElement(this.canvas);}
this.ctx=this.canvas.getContext('2d');this.chartx=0;this.charty=0;this.xlen=xlen;this.ymin=ymin;this.ymax=ymax;this.xgd=xgd;this.ygd=ygd;this.calc(this.chartw,this.charth,xlen,ymin,ymax,xgd,ygd);},drawLegend:function(series){var legend,list;legend=new Element('div',{'styles':{'position':'absolute','right':0},'class':'legend'});list=new Element('ul').injectInside(legend.injectInside(this.el));series.each(function(serie){new Element('span',{'styles':{'color':'black'}}).appendText(serie.label).injectInside(new Element('li',{'styles':{'color':serie.color}}).injectInside(list));});this.legend=legend.setStyle('top',this.charty+(this.charth-legend.offsetHeight)/2);this.chartw=this.w-(this.legend.offsetWidth+5);this.calc(this.chartw,this.charth,this.xlen,this.ymin,this.ymax,this.xgd,this.ygd);},drawVerticalLabels:function(ygd,precision,labelPos){var item,y,ty,pos;var xLblIn=(labelPos.x.toLowerCase()=='in');var yLblIn=(labelPos.y.toLowerCase()=='in');var multiplier=Math.pow(10,precision);var step=this.range/(ygd-1);var axis=new Element('div',{'styles':{'position':'absolute','left':yLblIn?10:0,'top':0,'textAlign':'right'}}).injectInside(this.el);this.ctx.fillStyle='black';var w=0;var items=[];for(n=0,i=this.ymax;(i>this.ymin)&&(n<ygd-1);i-=step,n++){item=new Element('span').setText(parseInt(i*multiplier)/multiplier).injectInside(axis);items.push([i,item]);w=Math.max(w,item.offsetWidth);}
item=new Element('span').setText(this.ymin).injectInside(axis);items.push([this.ymin,item]);w=Math.max(w,item.offsetWidth);var lblWidth=yLblIn?5:w+5;var lblHeight=xLblIn?Math.max(item.offsetHeight/2,5):item.offsetHeight+5;this.chartx=lblWidth;this.charty=item.offsetHeight/2;this.charth=this.h-(lblHeight+this.charty);this.chartw=this.w-((this.legend?this.legend.offsetWidth:0)+5+lblWidth);this.calc(this.chartw,this.charth,this.xlen,this.ymin,this.ymax,this.xgd,this.ygd);axis.setStyle('width',w+10);var n=this.range/this.charth;var yoffset=this.ymin/n;items.each(function(item){label=item[1];pos=item[0];if(pos==this.ymin){y=this.charty+this.charth-1;}else{y=this.charty+(this.charth-(pos/n)+yoffset);}
this.ctx.fillRect(this.chartx-5,y,5,1);ty=y-(label.offsetHeight/2);label.setStyles({'position':'absolute','top':ty,'background':'white'});label.setStyle(yLblIn?'left':'right',0);},this);},drawHorizontalLabels:function(xlen,labels,xgd,precision,labelPos){var axis,item,step,x,tx;var xLblIn=(labelPos.x.toLowerCase()=='in');var multiplier=Math.pow(10,precision);var n=this.chartw/(xgd-1);axis=new Element('div',{'styles':{'position':'absolute','left':0,'top':this.charty+this.charth+5,'width':this.w}}).injectInside(this.el);this.ctx.fillStyle='black';for(i=0;i<xgd;i++){item=new Element('span').setText(labels[i]).injectInside(axis);x=this.chartx+(n*i);tx=x-(item.offsetWidth/2);tx=Math.max(tx,this.chartx);tx=Math.min(tx,this.chartx+this.chartw-item.offsetWidth)
item.setStyles({'position':'absolute','left':tx,'top':'0px'});this.ctx.fillRect(x,this.charty+this.charth,1,5);}
if(xLblIn){axis.setStyle('top',this.charty+this.charth-item.offsetHeight);}},drawAxis:function(){this.ctx.fillStyle='black';this.ctx.fillRect(this.chartx,this.charty,1,this.charth-1);this.ctx.fillRect(this.chartx,this.charty+this.charth-1,this.chartw+1,1);},drawBackground:function(){this.ctx.fillStyle='white';this.ctx.fillRect(0,0,this.w,this.h);},drawGrid:function(){this.ctx.fillStyle='silver';if(this.xgrid){for(i=this.xgrid;i<this.chartw;i+=this.xgrid){this.ctx.fillRect(this.chartx+i,this.charty,1,this.charth-1);}}
if(this.ygrid){for(i=this.charth-this.ygrid;i>0;i-=this.ygrid){this.ctx.fillRect(this.chartx+1,this.charty+i,this.chartw,1);}
if((this.ymin*this.ymax)<0){this.ctx.fillStyle='#FFA07A';var y0=this.ymax*this.charth/(this.ymax-this.ymin);this.ctx.fillRect(this.chartx+1,this.charty+y0,this.chartw,1);}}},drawArea:function(color,values){var i,x,y;var n=this.range/this.charth;var yoffset=(this.ymin/n);var len=values.length;if(len){this.ctx.fillStyle=color;x=this.chartx+1;this.ctx.beginPath();this.ctx.moveTo(x,this.charty+this.charth-1);y=this.charty+this.charth-(values[0]/n)+yoffset;this.ctx.lineTo(x,y);for(i=1;i<len;i++){y=this.charty+this.charth-(values[i]/n)+yoffset;x+=this.xstep;this.ctx.lineTo(x,y);}
this.ctx.lineTo(x,this.charty+this.charth-1);this.ctx.closePath();this.ctx.fill();}},drawLine:function(color,values){var i,x,y;var n=this.range/this.charth;var yoffset=(this.ymin/n);var len=values.length;if(len){this.ctx.lineWidth=1;this.ctx.strokeStyle=color;x=this.chartx+1;y=this.charty+this.charth-(values[0]/n)+yoffset;this.ctx.beginPath();this.ctx.moveTo(x,y);for(i=1;i<len;i++){y=this.charty+this.charth-(values[i]/n)+yoffset;x+=this.xstep;this.ctx.lineTo(x,y);}
this.ctx.stroke();}},drawBars:function(color,values,xlen,xoffset,width){var i,x,y;var n=this.range/this.charth;var yoffset=(this.ymin/n);var len=values.length;if(len>xlen){len=xlen;}
if(len){this.ctx.fillStyle=color;x=this.chartx+xoffset+1;for(i=0;i<len;i++){y=this.charty+this.charth-(values[i]/n)+yoffset;this.ctx.beginPath();this.ctx.moveTo(x,this.charty+this.charth-1);this.ctx.lineTo(x,y);this.ctx.lineTo(x+width,y);this.ctx.lineTo(x+width,this.charty+this.charth-1);this.ctx.closePath();this.ctx.fill();x+=this.xstep;}}},getCoordinates:function(){return{left:this.chartx,top:this.charty,width:this.chartw,height:this.charth};}});var CHART_LINE=1;var CHART_AREA=2;var CHART_BAR=4;var CHART_STACKED=8;var Chart=new Class({options:{xGridDensity:0,yGridDensity:0,defaultFlags:0,labelPrecision:0,labelPos:{'x':'out','y':'in'},xLabels:[],barWidth:10,barDistance:2,showLegend:false},initialize:function(el,options){this.setOptions(options);this._cont=$(el);this._bar=0;this._series=[];this._chartCoordinates={};},setLabelPrecision:function(p){this.options.labelPrecision=p;},setShowLegend:function(b){this.options.showLegend=b;},setGridDensity:function(dx,dy){this.options.xGridDensity=dx;this.options.yGridDensity=dy;},setHorizontalLabels:function(labels){this.options.xLabels=labels;},add:function(label,color,values,flags){var offset;var opt=this.options;flags=$pick(flags,this._flags);if(flags&CHART_BAR){offset=opt.barDistance+this._bars*(opt.barWidth+opt.barDistance);this._bars++;}else{offset=0;}
this._series.push({'label':label,'color':color,'values':values,'flags':flags,'offset':offset});},draw:function(){var i,j,o,o2,len;if(!window.CanvasRenderingContext2D||!this._series){return;}
var series=[];var xlen=0;var ymin=this._series[0].values[0];var ymax=this._series[0].values[0];var opt=this.options;this._series.each(function(serie){if(serie.flags&CHART_STACKED)series.push(serie);});for(i=series.length-2;i>=0;i--){o=series[i].values;o2=series[i+1].values;len=Math.max(o2.length,o.length);for(j=0;j<len;j++){if((o[j])&&(!o2[j])){continue;}
if((!o[j])&&(o2[j])){o[j]=o2[j];}
else{o[j]=parseInt(o[j])+parseFloat(o2[j]);}}}
this._series.each(function(serie){if(!(serie.flags&CHART_STACKED))series.push(serie);});series.each(function(serie){xlen=Math.max(xlen,serie.values.length);for(i=serie.values.length-1;i>=0;i--){o=serie.values[i];ymin=Math.min(ymin,o);ymax=Math.max(ymax,o);}});if(ymin==ymax){ymin-=1;ymax+=1;}
if(this._series.length==this._bars){xlen++;opt.xGridDensity++;}
var bLabels=(opt.xGridDensity&&opt.yGridDensity&&(opt.xLabels.length>=opt.xGridDensity));var painter=new CanvasChartPainter(this._cont,xlen,ymin,ymax,opt.xGridDensity,opt.yGridDensity,bLabels);painter.drawBackground();if(opt.showLegend){painter.drawLegend(series);}
if(bLabels){painter.drawVerticalLabels(opt.yGridDensity,opt.labelPrecision,opt.labelPos);painter.drawHorizontalLabels(xlen,opt.xLabels,opt.xGridDensity,opt.labelPrecision,opt.labelPos);}
painter.drawGrid();series.each(function(serie){switch(serie.flags&~CHART_STACKED){case CHART_LINE:painter.drawLine(serie.color,serie.values);break;case CHART_AREA:painter.drawArea(serie.color,serie.values);break;case CHART_BAR:painter.drawBars(serie.color,serie.values,xlen-1,serie.offset,opt.barWidth);break;default:;};});painter.drawAxis();this._chartCoordinates=painter.getCoordinates();},getCoordinates:function(){return this._chartCoordinates;}});Chart.implement(new Options);if(!window.CanvasRenderingContext2D){(function(){var I=Math,i=I.round,L=I.sin,M=I.cos,m=10,A=m/2,Q={init:function(a){var b=a||document;if(/MSIE/.test(navigator.userAgent)&&!window.opera){var c=this;b.attachEvent("onreadystatechange",function(){c.r(b)})}},r:function(a){if(a.readyState=="complete"){if(!a.namespaces["s"]){a.namespaces.add("g_vml_","urn:schemas-microsoft-com:vml")}var b=a.createStyleSheet();b.cssText="canvas{display:inline-block;overflow:hidden;text-align:left;width:300px;height:150px}g_vml_\\:*{behavior:url(#default#VML)}";var c=a.getElementsByTagName("canvas");for(var d=0;d<c.length;d++){if(!c[d].getContext){this.initElement(c[d])}}}},q:function(a){var b=a.outerHTML,c=a.ownerDocument.createElement(b);if(b.slice(-2)!="/>"){var d="/"+a.tagName,e;while((e=a.nextSibling)&&e.tagName!=d){e.removeNode()}if(e){e.removeNode()}}a.parentNode.replaceChild(c,a);return c},initElement:function(a){a=this.q(a);a.getContext=function(){if(this.l){return this.l}return this.l=new K(this)};a.attachEvent("onpropertychange",V);a.attachEvent("onresize",W);var b=a.attributes;if(b.width&&b.width.specified){a.style.width=b.width.nodeValue+"px"}else{a.width=a.clientWidth}if(b.height&&b.height.specified){a.style.height=b.height.nodeValue+"px"}else{a.height=a.clientHeight}return a}};function V(a){var b=a.srcElement;switch(a.propertyName){case"width":b.style.width=b.attributes.width.nodeValue+"px";b.getContext().clearRect();break;case"height":b.style.height=b.attributes.height.nodeValue+"px";b.getContext().clearRect();break}}function W(a){var b=a.srcElement;if(b.firstChild){b.firstChild.style.width=b.clientWidth+"px";b.firstChild.style.height=b.clientHeight+"px"}}Q.init();var R=[];for(var E=0;E<16;E++){for(var F=0;F<16;F++){R[E*16+F]=E.toString(16)+F.toString(16)}}function J(){return[[1,0,0],[0,1,0],[0,0,1]]}function G(a,b){var c=J();for(var d=0;d<3;d++){for(var e=0;e<3;e++){var g=0;for(var h=0;h<3;h++){g+=a[d][h]*b[h][e]}c[d][e]=g}}return c}function N(a,b){b.fillStyle=a.fillStyle;b.lineCap=a.lineCap;b.lineJoin=a.lineJoin;b.lineWidth=a.lineWidth;b.miterLimit=a.miterLimit;b.shadowBlur=a.shadowBlur;b.shadowColor=a.shadowColor;b.shadowOffsetX=a.shadowOffsetX;b.shadowOffsetY=a.shadowOffsetY;b.strokeStyle=a.strokeStyle;b.d=a.d;b.e=a.e}function O(a){var b,c=1;a=String(a);if(a.substring(0,3)=="rgb"){var d=a.indexOf("(",3),e=a.indexOf(")",d+1),g=a.substring(d+1,e).split(",");b="#";for(var h=0;h<3;h++){b+=R[Number(g[h])]}if(g.length==4&&a.substr(3,1)=="a"){c=g[3]}}else{b=a}return[b,c]}function S(a){switch(a){case"butt":return"flat";case"round":return"round";case"square":default:return"square"}}function K(a){this.a=J();this.m=[];this.k=[];this.c=[];this.strokeStyle="#000";this.fillStyle="#000";this.lineWidth=1;this.lineJoin="miter";this.lineCap="butt";this.miterLimit=m*1;this.globalAlpha=1;this.canvas=a;var b=a.ownerDocument.createElement("div");b.style.width=a.clientWidth+"px";b.style.height=a.clientHeight+"px";b.style.overflow="hidden";b.style.position="absolute";a.appendChild(b);this.j=b;this.d=1;this.e=1}var j=K.prototype;j.clearRect=function(){this.j.innerHTML="";this.c=[]};j.beginPath=function(){this.c=[]};j.moveTo=function(a,b){this.c.push({type:"moveTo",x:a,y:b});this.f=a;this.g=b};j.lineTo=function(a,b){this.c.push({type:"lineTo",x:a,y:b});this.f=a;this.g=b};j.bezierCurveTo=function(a,b,c,d,e,g){this.c.push({type:"bezierCurveTo",cp1x:a,cp1y:b,cp2x:c,cp2y:d,x:e,y:g});this.f=e;this.g=g};j.quadraticCurveTo=function(a,b,c,d){var e=this.f+0.6666666666666666*(a-this.f),g=this.g+0.6666666666666666*(b-this.g),h=e+(c-this.f)/3,l=g+(d-this.g)/3;this.bezierCurveTo(e,g,h,l,c,d)};j.arc=function(a,b,c,d,e,g){c*=m;var h=g?"at":"wa",l=a+M(d)*c-A,n=b+L(d)*c-A,o=a+M(e)*c-A,f=b+L(e)*c-A;if(l==o&&!g){l+=0.125}this.c.push({type:h,x:a,y:b,radius:c,xStart:l,yStart:n,xEnd:o,yEnd:f})};j.rect=function(a,b,c,d){this.moveTo(a,b);this.lineTo(a+c,b);this.lineTo(a+c,b+d);this.lineTo(a,b+d);this.closePath()};j.strokeRect=function(a,b,c,d){this.beginPath();this.moveTo(a,b);this.lineTo(a+c,b);this.lineTo(a+c,b+d);this.lineTo(a,b+d);this.closePath();this.stroke()};j.fillRect=function(a,b,c,d){this.beginPath();this.moveTo(a,b);this.lineTo(a+c,b);this.lineTo(a+c,b+d);this.lineTo(a,b+d);this.closePath();this.fill()};j.createLinearGradient=function(a,b,c,d){var e=new H("gradient");return e};j.createRadialGradient=function(a,b,c,d,e,g){var h=new H("gradientradial");h.n=c;h.o=g;h.i.x=a;h.i.y=b;return h};j.drawImage=function(a,b){var c,d,e,g,h,l,n,o,f=a.runtimeStyle.width,k=a.runtimeStyle.height;a.runtimeStyle.width="auto";a.runtimeStyle.height="auto";var q=a.width,r=a.height;a.runtimeStyle.width=f;a.runtimeStyle.height=k;if(arguments.length==3){c=arguments[1];d=arguments[2];h=(l=0);n=(e=q);o=(g=r)}else if(arguments.length==5){c=arguments[1];d=arguments[2];e=arguments[3];g=arguments[4];h=(l=0);n=q;o=r}else if(arguments.length==9){h=arguments[1];l=arguments[2];n=arguments[3];o=arguments[4];c=arguments[5];d=arguments[6];e=arguments[7];g=arguments[8]}else{throw"Invalid number of arguments";}var s=this.b(c,d),t=[],v=10,w=10;t.push(" <g_vml_:group",' coordsize="',m*v,",",m*w,'"',' coordorigin="0,0"',' style="width:',v,";height:",w,";position:absolute;");if(this.a[0][0]!=1||this.a[0][1]){var x=[];x.push("M11='",this.a[0][0],"',","M12='",this.a[1][0],"',","M21='",this.a[0][1],"',","M22='",this.a[1][1],"',","Dx='",i(s.x/m),"',","Dy='",i(s.y/m),"'");var p=s,y=this.b(c+e,d),z=this.b(c,d+g),B=this.b(c+e,d+g);p.x=Math.max(p.x,y.x,z.x,B.x);p.y=Math.max(p.y,y.y,z.y,B.y);t.push("padding:0 ",i(p.x/m),"px ",i(p.y/m),"px 0;filter:progid:DXImageTransform.Microsoft.Matrix(",x.join(""),", sizingmethod='clip');")}else{t.push("top:",i(s.y/m),"px;left:",i(s.x/m),"px;")}t.push(' ">','<g_vml_:image src="',a.src,'"',' style="width:',m*e,";"," height:",m*g,';"',' cropleft="',h/q,'"',' croptop="',l/r,'"',' cropright="',(q-h-n)/q,'"',' cropbottom="',(r-l-o)/r,'"'," />","</g_vml_:group>");this.j.insertAdjacentHTML("BeforeEnd",t.join(""))};j.stroke=function(a){var b=[],c=O(a?this.fillStyle:this.strokeStyle),d=c[0],e=c[1]*this.globalAlpha,g=10,h=10;b.push("<g_vml_:shape",' fillcolor="',d,'"',' filled="',Boolean(a),'"',' style="position:absolute;width:',g,";height:",h,';"',' coordorigin="0 0" coordsize="',m*g," ",m*h,'"',' stroked="',!a,'"',' strokeweight="',this.lineWidth,'"',' strokecolor="',d,'"',' path="');var l={x:null,y:null},n={x:null,y:null};for(var o=0;o<this.c.length;o++){var f=this.c[o];if(f.type=="moveTo"){b.push(" m ");var k=this.b(f.x,f.y);b.push(i(k.x),",",i(k.y))}else if(f.type=="lineTo"){b.push(" l ");var k=this.b(f.x,f.y);b.push(i(k.x),",",i(k.y))}else if(f.type=="close"){b.push(" x ")}else if(f.type=="bezierCurveTo"){b.push(" c ");var k=this.b(f.x,f.y),q=this.b(f.cp1x,f.cp1y),r=this.b(f.cp2x,f.cp2y);b.push(i(q.x),",",i(q.y),",",i(r.x),",",i(r.y),",",i(k.x),",",i(k.y))}else if(f.type=="at"||f.type=="wa"){b.push(" ",f.type," ");var k=this.b(f.x,f.y),s=this.b(f.xStart,f.yStart),t=this.b(f.xEnd,f.yEnd);b.push(i(k.x-this.d*f.radius),",",i(k.y-this.e*f.radius)," ",i(k.x+this.d*f.radius),",",i(k.y+this.e*f.radius)," ",i(s.x),",",i(s.y)," ",i(t.x),",",i(t.y))}if(k){if(l.x==null||k.x<l.x){l.x=k.x}if(n.x==null||k.x>n.x){n.x=k.x}if(l.y==null||k.y<l.y){l.y=k.y}if(n.y==null||k.y>n.y){n.y=k.y}}}b.push(' ">');if(typeof this.fillStyle=="object"){var v={x:"50%",y:"50%"},w=n.x-l.x,x=n.y-l.y,p=w>x?w:x;v.x=i(this.fillStyle.i.x/w*100+50)+"%";v.y=i(this.fillStyle.i.y/x*100+50)+"%";var y=[];if(this.fillStyle.p=="gradientradial"){var z=this.fillStyle.n/p*100,B=this.fillStyle.o/p*100-z}else{var z=0,B=100}var C={offset:null,color:null},D={offset:null,color:null};this.fillStyle.h.sort(function(T,U){return T.offset-U.offset});for(var o=0;o<this.fillStyle.h.length;o++){var u=this.fillStyle.h[o];y.push(u.offset*B+z,"% ",u.color,",");if(u.offset>C.offset||C.offset==null){C.offset=u.offset;C.color=u.color}if(u.offset<D.offset||D.offset==null){D.offset=u.offset;D.color=u.color}}y.pop();b.push("<g_vml_:fill",' color="',D.color,'"',' color2="',C.color,'"',' type="',this.fillStyle.p,'"',' focusposition="',v.x,", ",v.y,'"',' colors="',y.join(""),'"',' opacity="',e,'" />')}else if(a){b.push('<g_vml_:fill color="',d,'" opacity="',e,'" />')}else{b.push("<g_vml_:stroke",' opacity="',e,'"',' joinstyle="',this.lineJoin,'"',' miterlimit="',this.miterLimit,'"',' endcap="',S(this.lineCap),'"',' weight="',this.lineWidth,'px"',' color="',d,'" />')}b.push("</g_vml_:shape>");this.j.insertAdjacentHTML("beforeEnd",b.join(""));this.c=[]};j.fill=function(){this.stroke(true)};j.closePath=function(){this.c.push({type:"close"})};j.b=function(a,b){return{x:m*(a*this.a[0][0]+b*this.a[1][0]+this.a[2][0])-A,y:m*(a*this.a[0][1]+b*this.a[1][1]+this.a[2][1])-A}};j.save=function(){var a={};N(this,a);this.k.push(a);this.m.push(this.a);this.a=G(J(),this.a)};j.restore=function(){N(this.k.pop(),this);this.a=this.m.pop()};j.translate=function(a,b){var c=[[1,0,0],[0,1,0],[a,b,1]];this.a=G(c,this.a)};j.rotate=function(a){var b=M(a),c=L(a),d=[[b,c,0],[-c,b,0],[0,0,1]];this.a=G(d,this.a)};j.scale=function(a,b){this.d*=a;this.e*=b;var c=[[a,0,0],[0,b,0],[0,0,1]];this.a=G(c,this.a)};j.clip=function(){};j.arcTo=function(){};j.createPattern=function(){return new P};function H(a){this.p=a;this.n=0;this.o=0;this.h=[];this.i={x:0,y:0}}H.prototype.addColorStop=function(a,b){b=O(b);this.h.push({offset:1-a,color:b})};function P(){}G_vmlCanvasManager=Q;CanvasRenderingContext2D=K;CanvasGradient=H;CanvasPattern=P})()};